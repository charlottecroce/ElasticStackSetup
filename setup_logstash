#!/bin/sh

#installation
apt-get install logstash -y

#pipeline configuration
echo -e "input{\n\tbeats{\n\t\tport => 5044\n\t\tssl => true\n\t\tssl_certificate => '/etc/pki/tls/certs/logstash-forwarder.crt'\n\t\tssl_key => '/etc/pki/tls/private/logstash-forwarder.key'\n\t}\n}" > /etc/logstash/conf.d/beats_input.conf
echo -e "output{\n\telasticsearch{\n\t\thosts => ['localhost:9200', '127.0.0.1:9200']\n\t\tmanage_template => false\n\t\tindex => '%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}'\n\t\taction => create\n\t}\n}" > /etc/logstash/conf.d/elasticsearch_output.conf

#service configuration
#logstash can take a very long time to shut down. this kills the process after 3 minutes of shutting down
sed -i 's/.TimeoutStopSec.*/TimeoutStopSec=180/' /etc/systemd/system/logstash.service

#enable
systemctl enable logstash
