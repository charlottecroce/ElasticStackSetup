#
# must be run as root
# must be run after setup_install and setup_passwords have both been run
#

CYAN='\033[1;36m'
NC='\033[0m'

echo -e "${CYAN}Stopping elasticsearch.service${NC}"
systemctl stop elasticsearch.service

echo -e "${CYAN}Generating random passwords for CA and certificate${NC}"
CAPASS=$(pwgen 16 1)
CERTIFICATEPASS=$(pwgen 16 1)

echo -e "${CYAN}Creating CA and certificate${NC}"
printf '\n%s\n' ${CAPASS} | /usr/share/elasticsearch/bin/elasticsearch-certutil ca
printf '%s\n\n%s\n' ${CAPASS} ${CERTIFICATEPASS} | /usr/share/elasticsearch/bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12

echo -e "${CYAN}Moving certificates to /etc/elasticsearch directory${NC}"
mv /usr/share/elasticsearch/elastic-certificates.p12 /etc/elasticsearch/
sudo chown elasticsearch: /etc/elasticsearch/elastic-certificates.p12

echo -e "${CYAN}Configuring elasticsearch.yml file${NC}"
sed -i '/.*cluster.name.*/ s/^#//' /etc/elasticsearch/elasticsearch.yml
sed -i '/.*node.name.*/ s/^#//' /etc/elasticsearch/elasticsearch.yml
sed -i '/.*xpack.security.transport.ssl.enabled.*/ s/^#//' /etc/elasticsearch/elasticsearch.yml
sed -i '/.*xpack.security.transport.ssl.verification_mode.*/ s/^#//' /etc/elasticsearch/elasticsearch.yml
sed -i '/.*xpack.security.transport.ssl.client_authentication.*/ s/^#//' /etc/elasticsearch/elasticsearch.yml
sed -i '/.*xpack.security.transport.ssl.keystore.path.*/ s/^#//' /etc/elasticsearch/elasticsearch.yml
sed -i '/.*xpack.security.transport.ssl.truststore.path.*/ s/^#//' /etc/elasticsearch/elasticsearch.yml

echo -e "${CYAN}Adding certificate password to elasticsearch-keystore${NC}"
printf '%s\n' ${CERTIFICATEPASS} | /usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
printf '%s\n' ${CERTIFICATEPASS} | /usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password

echo -e "${CYAN}\nTHESE PASSWORDS ARE NOT STORED ANYWHERE. SAVE THEM SOMEPLACE SAFE${NC}"
echo -e "${CYAN}|${NC}"
echo -e "certificate authority password: ${CAPASS}"
echo -e "certificate password: ${CERTIFICATEPASS}"
echo -e "${CYAN}|${NC}"

echo -e "${CYAN}Starting elasticsearch.service${NC}"
systemctl start elasticsearch.service
